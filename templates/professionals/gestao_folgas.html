{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto px-4">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Gest√£o de Folgas e Feriados</h1>
            <p class="text-sm text-gray-500">Controle de aus√™ncias individuais e fechamento do sal√£o.</p>
        </div>
        <button onclick="novaFolga()" class="bg-red-500 text-white px-5 py-2.5 rounded-lg hover:bg-red-600 shadow-md transition flex items-center font-medium">
            <i class="fa-solid fa-calendar-minus mr-2"></i> Adicionar Bloqueio
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-600 uppercase tracking-wider">
                        <th class="px-6 py-4">Tipo</th>
                        <th class="px-6 py-4">Profissional / Local</th>
                        <th class="px-6 py-4">In√≠cio</th>
                        <th class="px-6 py-4">Fim</th>
                        <th class="px-6 py-4">Motivo</th>
                        <th class="px-6 py-4 text-right">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for folga in folgas %}
                    <tr class="hover:bg-red-50 transition duration-150">
                        <td class="px-6 py-4">
                            {% if folga.profissional %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800">
                                    INDIVIDUAL
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-orange-100 text-orange-800">
                                    COLETIVA
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-700 font-medium">
                            {{ folga.profissional.nome|default:"Sal√£o Inteiro (Fechado)" }}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {{ folga.data_inicio|date:"d/m/Y" }} <strong class="text-gray-800">{{ folga.data_inicio|date:"H:i" }}</strong>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            {{ folga.data_fim|date:"d/m/Y" }} <strong class="text-gray-800">{{ folga.data_fim|date:"H:i" }}</strong>
                        </td>
                         <td class="px-6 py-4 text-sm text-gray-500 italic">
                            {{ folga.motivo|default:"-" }}
                        </td>
                        <td class="px-6 py-4 text-right space-x-2">
                            <button onclick="editarFolga('{{ folga.id }}')" 
                                    class="text-blue-500 hover:text-blue-700 p-2 hover:bg-blue-100 rounded-full transition" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="excluirFolga('{{ folga.id }}')" 
                                    class="text-red-400 hover:text-red-600 p-2 hover:bg-red-100 rounded-full transition" title="Excluir">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-400 italic bg-gray-50">
                            <i class="fa-regular fa-calendar-xmark text-4xl mb-3 block opacity-30"></i>
                            Nenhum bloqueio de agenda encontrado.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- GERA OP√á√ïES DE HOR√ÅRIO (00 e 30 min) ---
function getHorariosOptions(selectedTime) {
    let options = '';
    // Gera das 00:00 as 23:30
    for (let h = 0; h < 24; h++) {
        for (let m of ['00', '30']) {
            let hora = `${h.toString().padStart(2, '0')}:${m}`;
            let isSelected = hora === selectedTime ? 'selected' : '';
            options += `<option value="${hora}" ${isSelected}>${hora}</option>`;
        }
    }
    return options;
}

// --- Separar Data e Hora ISO (YYYY-MM-DDTHH:MM) ---
function splitIso(isoString) {
    if (!isoString) return { date: '', time: '08:00' };
    const parts = isoString.split('T');
    return { date: parts[0], time: parts[1].substring(0, 5) }; // Pega HH:MM
}

function novaFolga() {
    abrirModalFolga();
}

async function editarFolga(id) {
    try {
        const response = await fetch(`/equipe/api/get-folga/${id}/`);
        const dados = await response.json();
        abrirModalFolga(dados, id);
    } catch (e) {
        console.error(e);
        Swal.fire('Erro', 'N√£o foi poss√≠vel carregar os dados.', 'error');
    }
}

// --- MODAL PRINCIPAL ---
function abrirModalFolga(dados = null, id = null) {
    const titulo = id ? 'Editar Bloqueio' : 'Novo Bloqueio';
    const btnTexto = id ? 'Salvar Altera√ß√µes' : 'Criar Bloqueio';
    const corBtn = id ? '#3b82f6' : '#ef4444';
    
    // Processa valores iniciais (Separa Data e Hora)
    const tipo = dados ? (dados.tipo === 'individual' ? 'individual' : 'coletiva') : 'coletiva';
    const profId = dados ? dados.profissional_id : '';
    const motivo = dados ? dados.motivo : '';
    
    const inicioObj = splitIso(dados ? dados.inicio : '');
    const fimObj = splitIso(dados ? dados.fim : '');

    // HTML do Modal
    Swal.fire({
        title: `<span class="text-xl font-bold text-gray-800">${titulo}</span>`,
        html: `
            <div class="text-left space-y-4 px-2">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
                    <select id="f-tipo" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 transition" onchange="toggleProf(this.value)">
                        <option value="coletiva" ${tipo === 'coletiva' ? 'selected' : ''}>üè¢ Coletiva (Sal√£o Fechado)</option>
                        <option value="individual" ${tipo === 'individual' ? 'selected' : ''}>üë§ Individual (Profissional)</option>
                    </select>
                </div>

                <div id="div-prof" class="${tipo === 'coletiva' ? 'hidden' : ''}">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Profissional</label>
                    <select id="f-prof" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        {% for p in profissionais %}
                        <option value="{{ p.id }}" ${profId == '{{ p.id }}' ? 'selected' : ''}>{{ p.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data In√≠cio</label>
                        <input type="date" id="f-data-ini" value="${inicioObj.date}" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hora In√≠cio</label>
                        <select id="f-hora-ini" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            ${getHorariosOptions(inicioObj.time || '08:00')}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data Fim</label>
                        <input type="date" id="f-data-fim" value="${fimObj.date}" 
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hora Fim</label>
                        <select id="f-hora-fim" class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            ${getHorariosOptions(fimObj.time || '18:00')}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Motivo</label>
                    <input id="f-motivo" value="${motivo}" placeholder="Ex: Feriado, M√©dico..." 
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: btnTexto,
        cancelButtonText: 'Cancelar',
        confirmButtonColor: corBtn,
        width: '500px',
        preConfirm: () => {
            const dIni = document.getElementById('f-data-ini').value;
            const hIni = document.getElementById('f-hora-ini').value;
            const dFim = document.getElementById('f-data-fim').value;
            const hFim = document.getElementById('f-hora-fim').value;

            if (!dIni || !dFim) {
                Swal.showValidationMessage('Preencha as datas corretamente');
                return false;
            }

            // Junta Data e Hora no formato ISO para o Python
            return {
                profissional_id: document.getElementById('f-tipo').value === 'individual' ? document.getElementById('f-prof').value : 'coletiva',
                inicio: `${dIni}T${hIni}`,
                fim: `${dFim}T${hFim}`,
                motivo: document.getElementById('f-motivo').value
            }
        }
    }).then(result => {
        if(result.isConfirmed) {
            const url = id ? `/equipe/api/edit-folga/${id}/` : "/equipe/api/add-folga/";
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(result.value)
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') location.reload();
                else Swal.fire('Erro', data.message || 'Erro ao salvar', 'error');
            })
            .catch(err => Swal.fire('Erro', 'Falha na comunica√ß√£o', 'error'));
        }
    });
}

function excluirFolga(id) {
    Swal.fire({
        title: 'Remover Bloqueio?',
        text: "O hor√°rio voltar√° a ficar dispon√≠vel.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        confirmButtonText: 'Sim, remover',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/equipe/api/delete-folga/${id}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') location.reload();
                else Swal.fire('Erro', 'N√£o foi poss√≠vel excluir.', 'error');
            });
        }
    });
}

function toggleProf(val) {
    const div = document.getElementById('div-prof');
    if (val === 'coletiva') {
        div.classList.add('hidden');
    } else {
        div.classList.remove('hidden');
    }
}
</script>
{% endblock %}