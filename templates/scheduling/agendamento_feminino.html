{% extends 'base.html' %}
{% load static %}

{% block title %}Agendamento | {{ empresa.nome }}{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    /* --- TEMA ROSA BEBÊ (BABY PINK) --- */
    body { 
        font-family: 'Manrope', sans-serif; 
        background-color: #fff0f5 !important; /* LavenderBlush (Rosa muito claro) */
        color: #5e4b56; /* Cinza/Marrom suave para texto */
        overflow-x: hidden;
    }
    h1, h2, h3, h4, .font-serif { font-family: 'Playfair Display', serif; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #fff0f5; }
    ::-webkit-scrollbar-thumb { background: #f9a8d4; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #ec4899; }

    /* Animações */
    .step-content {
        display: none; 
        animation-duration: 0.8s;
        animation-fill-mode: forwards;
        animation-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .step-content.active {
        display: block;
        opacity: 1;
        transform: translateX(0) scale(1);
    }
    @keyframes slideInRightBounce {
        0% { opacity: 0; transform: translateX(60px) scale(0.95); }
        100% { opacity: 1; transform: translateX(0) scale(1); }
    }
    @keyframes slideInLeftBounce {
        0% { opacity: 0; transform: translateX(-60px) scale(0.95); }
        100% { opacity: 1; transform: translateX(0) scale(1); }
    }
    .step-enter-right { display: block !important; animation-name: slideInRightBounce; }
    .step-enter-left { display: block !important; animation-name: slideInLeftBounce; }

    /* Flatpickr (Calendário) */
    .flatpickr-calendar {
        background: #ffffff !important;
        border: 1px solid #fbcfe8 !important;
        box-shadow: 0 10px 30px -5px rgba(244, 114, 182, 0.15) !important;
        border-radius: 24px !important;
        padding: 16px !important;
        width: 100% !important;
        max-width: 400px;
        margin: 0 auto;
    }
    .flatpickr-months { border-bottom: 1px solid #fbcfe8; padding-bottom: 10px; margin-bottom: 10px; }
    .flatpickr-month { color: #db2777 !important; fill: #db2777 !important; } /* Rosa Forte */
    .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-current-month input.cur-year {
        color: #db2777 !important; font-family: 'Playfair Display', serif; font-weight: 700;
    }
    .flatpickr-weekday { color: #f472b6 !important; font-weight: 600 !important; text-transform: uppercase; font-size: 11px; }
    .flatpickr-day { color: #5e4b56 !important; border-radius: 12px !important; font-weight: 500; border: 1px solid transparent !important; }
    .flatpickr-day.flatpickr-disabled { color: #cbd5e1 !important; opacity: 0.5; }
    .flatpickr-day:hover { background: #fdf2f8 !important; border-color: #fbcfe8 !important; }
    .flatpickr-day.selected { background: #db2777 !important; color: #ffffff !important; font-weight: 800; box-shadow: 0 4px 10px rgba(219, 39, 119, 0.3) !important; }
    .flatpickr-prev-month, .flatpickr-next-month { fill: #db2777 !important; }

    /* Categoria Ativa */
    .cat-btn { background-color: #ffffff; color: #9ca3af; }
    .cat-btn.active {
        background-color: #f9a8d4; /* Rosa Pastel Médio */
        color: #831843; /* Texto Vinho para contraste */
        border-color: #f9a8d4;
        box-shadow: 0 4px 15px rgba(249, 168, 212, 0.4);
        transform: translateY(-1px);
    }
</style>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    dark: { bg: '#fff0f5', card: '#ffffff', border: '#fce7f3' },
                    primary: { 
                        DEFAULT: '#f9a8d4', // Rosa Pastel (Pink-300)
                        hover: '#f472b6',   // Pink-400
                        strong: '#db2777',  // Pink-600 (Para botão confirmar)
                        muted: '#9ca3af',
                        dim: 'rgba(249, 168, 212, 0.1)'
                    }
                }
            }
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-dark-bg flex flex-col items-center py-10 px-4">

    <div class="text-center mb-12 animate-fade-in">
        {% if empresa.logo %}
            <img src="{{ empresa.logo.url }}" class="w-20 h-20 mx-auto rounded-full object-cover border-2 border-primary-DEFAULT mb-4 shadow-md shadow-pink-200">
        {% else %}
            <div class="w-16 h-16 bg-white text-primary-DEFAULT rounded-full flex items-center justify-center mx-auto mb-4 border border-primary-DEFAULT/30 shadow-sm">
                <i class="fa-solid fa-spa text-2xl"></i>
            </div>
        {% endif %}
        <h1 class="text-4xl text-primary-strong font-bold tracking-wide mb-1">{{ empresa.nome }}</h1>
        <div class="h-1 w-16 bg-primary-DEFAULT mx-auto rounded-full opacity-80"></div>
    </div>

    <div class="w-full max-w-4xl mb-14 relative px-6">
        <div class="flex justify-between items-center relative z-10">
            <div id="step-indicator-1" class="flex flex-col items-center transition-all duration-500 transform scale-110">
                <div class="w-10 h-10 rounded-full bg-primary-DEFAULT text-white flex items-center justify-center font-bold mb-2 shadow-md shadow-pink-200">1</div>
                <span class="text-[10px] uppercase tracking-widest text-primary-strong font-bold">Serviço</span>
            </div>
            <div class="flex-1 h-[1px] bg-pink-200 mx-4"></div>
            <div id="step-indicator-2" class="flex flex-col items-center opacity-50 transition-all duration-500">
                <div class="w-10 h-10 rounded-full bg-white border border-pink-100 text-gray-400 flex items-center justify-center font-bold mb-2">2</div>
                <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Profissional</span>
            </div>
             <div class="flex-1 h-[1px] bg-pink-200 mx-4"></div>
            <div id="step-indicator-3" class="flex flex-col items-center opacity-50 transition-all duration-500">
                <div class="w-10 h-10 rounded-full bg-white border border-pink-100 text-gray-400 flex items-center justify-center font-bold mb-2">3</div>
                <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Data</span>
            </div>
             <div class="flex-1 h-[1px] bg-pink-200 mx-4"></div>
            <div id="step-indicator-4" class="flex flex-col items-center opacity-50 transition-all duration-500">
                <div class="w-10 h-10 rounded-full bg-white border border-pink-100 text-gray-400 flex items-center justify-center font-bold mb-2">4</div>
                <span class="text-[10px] uppercase tracking-widest text-gray-400 font-bold">Fim</span>
            </div>
        </div>
    </div>

    <div class="w-full max-w-4xl relative min-h-[600px] transition-all">
        
        <div id="step-1" class="step-content active" style="display: block;">
            <h2 class="text-3xl text-center text-primary-strong mb-2 font-serif">Selecione o <span class="italic font-bold">Serviço</span></h2>
            <p class="text-center text-gray-500 mb-10 font-light tracking-wide">O que vamos realçar em você hoje?</p>

            <div class="flex flex-wrap justify-center gap-3 mb-10">
                {% for cat in categorias %}
                <button onclick="filterServices('{{ cat.id }}', this)" 
                        class="cat-btn px-6 py-3 rounded-full border border-pink-100 transition-all duration-300 text-xs font-bold uppercase tracking-widest flex items-center gap-2
                        {% if forloop.first %}active{% endif %}"
                        data-cat-id="{{ cat.id }}">
                    {% if cat.icone %}
                        <img src="{{ cat.icone.url }}" class="w-4 h-4 object-contain opacity-60 icon-colored"> 
                    {% endif %}
                    {{ cat.nome }}
                </button>
                {% endfor %}
            </div>

            <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="min-height: 200px;">
                <div class="col-span-full py-12 text-center text-primary-DEFAULT animate-pulse">Carregando...</div>
            </div>
        </div>

        <div id="step-2" class="step-content">
            <div class="flex justify-between items-center mb-8 px-2">
                <button onclick="goToStep(1)" class="text-gray-400 hover:text-primary-strong transition flex items-center gap-2 text-xs uppercase font-bold tracking-widest group">
                    <div class="w-8 h-8 rounded-full border border-pink-200 flex items-center justify-center group-hover:bg-primary-DEFAULT group-hover:text-white transition">
                        <i class="fa-solid fa-arrow-left"></i>
                    </div>
                    Voltar
                </button>
                <h2 class="text-3xl text-primary-strong font-serif text-right">A <span class="italic font-bold">Profissional</span></h2>
            </div>
            <div id="professionals-grid" class="grid grid-cols-2 md:grid-cols-3 gap-6"></div>
        </div>

        <div id="step-3" class="step-content">
            <div class="flex justify-between items-center mb-8 px-2">
                <button onclick="goToStep(2)" class="text-gray-400 hover:text-primary-strong transition flex items-center gap-2 text-xs uppercase font-bold tracking-widest group">
                    <div class="w-8 h-8 rounded-full border border-pink-200 flex items-center justify-center group-hover:bg-primary-DEFAULT group-hover:text-white transition">
                        <i class="fa-solid fa-arrow-left"></i>
                    </div>
                    Voltar
                </button>
                <h2 class="text-3xl text-primary-strong font-serif text-right">O <span class="italic font-bold">Momento</span></h2>
            </div>
            
            <div class="grid lg:grid-cols-2 gap-12 items-start">
                <div class="relative">
                    <div class="absolute -inset-2 bg-pink-100 rounded-[30px] blur-xl opacity-50"></div>
                    <div class="relative bg-white rounded-3xl shadow-sm border border-pink-50">
                        <input type="text" id="calendar-inline" class="hidden">
                    </div>
                </div>

                <div class="bg-white border border-pink-100 rounded-3xl p-6 h-full min-h-[400px] flex flex-col shadow-sm">
                    <h3 class="text-lg text-primary-strong mb-6 flex justify-between items-center border-b border-pink-50 pb-4">
                        <span class="font-serif font-bold">Horários Livres</span>
                        <span id="selected-date-display" class="text-xs text-primary-strong font-bold uppercase tracking-widest border border-pink-100 px-3 py-1 rounded-full bg-pink-50">-</span>
                    </h3>
                    <div id="time-slots" class="grid grid-cols-2 gap-3 overflow-y-auto pr-2 custom-scrollbar flex-1 content-start">
                        <div class="col-span-2 py-20 text-center text-gray-400 italic border-2 border-dashed border-pink-100 rounded-xl">Selecione um dia</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="step-4" class="step-content">
            <div class="text-center mb-10">
                <h2 class="text-4xl text-primary-strong mb-2 font-serif">Confirmar <span class="italic font-bold">Agendamento</span></h2>
                <p class="text-gray-500 font-light">Tudo pronto para realçar sua beleza?</p>
            </div>

            <div class="bg-white border border-pink-100 rounded-[2rem] p-8 md:p-10 mb-8 relative overflow-hidden shadow-lg shadow-pink-100">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-primary-DEFAULT opacity-50"></div>
                
                <div class="grid md:grid-cols-2 gap-12 items-center">
                    <div class="space-y-6 border-b md:border-b-0 md:border-r border-pink-100 pb-6 md:pb-0 md:pr-6">
                        <div class="flex justify-between items-end">
                            <div><span class="block text-gray-400 text-[10px] uppercase tracking-widest mb-1">Serviço</span><span id="summary-service" class="text-primary-strong font-serif font-bold text-2xl leading-none"></span></div>
                            <span class="text-primary-DEFAULT text-xl"><i class="fa-solid fa-spa"></i></span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div><span class="block text-gray-400 text-[10px] uppercase tracking-widest mb-1">Profissional</span><span id="summary-professional" class="text-gray-700 font-bold text-lg"></span></div>
                            <span class="text-gray-400 text-lg"><i class="fa-regular fa-user"></i></span>
                        </div>
                        <div class="flex justify-between items-end">
                            <div><span class="block text-gray-400 text-[10px] uppercase tracking-widest mb-1">Data e Hora</span><span id="summary-datetime" class="text-gray-700 font-bold text-lg"></span></div>
                            <span class="text-gray-400 text-lg"><i class="fa-regular fa-calendar"></i></span>
                        </div>
                        <div class="pt-4 mt-4 border-t border-pink-100 flex justify-between items-center">
                            <span class="text-gray-400 text-xs uppercase tracking-widest">Valor Estimado</span>
                            <span id="summary-price" class="text-3xl text-primary-strong font-serif font-extrabold tracking-tight"></span>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <div class="relative group">
                            <i class="fa-solid fa-user absolute left-5 top-4 text-gray-400 group-focus-within:text-primary-strong transition-colors"></i>
                            <input type="text" id="client-name" placeholder="Seu Nome Completo" class="w-full bg-pink-50 border border-pink-100 rounded-xl py-3.5 pl-12 text-gray-700 focus:border-primary-strong focus:ring-1 focus:ring-primary-strong transition outline-none placeholder-gray-400 font-medium">
                        </div>
                        <div class="relative group">
                            <i class="fa-brands fa-whatsapp absolute left-5 top-4 text-gray-400 group-focus-within:text-primary-strong transition-colors"></i>
                            <input type="text" id="client-phone" placeholder="Seu WhatsApp (DDD)" class="w-full bg-pink-50 border border-pink-100 rounded-xl py-3.5 pl-12 text-gray-700 focus:border-primary-strong focus:ring-1 focus:ring-primary-strong transition outline-none placeholder-gray-400 font-medium">
                        </div>
                        
                        <button onclick="confirmBooking()" class="w-full bg-primary-strong hover:bg-pink-700 text-white font-extrabold py-4 rounded-xl shadow-lg shadow-pink-200 hover:shadow-xl hover:shadow-pink-300 transition-all transform hover:-translate-y-0.5 mt-2">
                            CONFIRMAR AGENDAMENTO
                        </button>
                    </div>
                </div>
            </div>
            
            <button onclick="goToStep(3)" class="w-full text-center text-gray-400 hover:text-primary-strong transition text-xs font-bold uppercase tracking-widest"><i class="fa-solid fa-pen mr-2"></i> Corrigir Dados</button>
        </div>
    </div>
</div>

<script>
    const LIMITE_AGENDAMENTO_DIAS = {{ empresa.limite_agendamento_dias|default:30 }};
</script>
<script src="{% static 'js/agendamento.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const firstCatBtn = document.querySelector('.cat-btn');
        if(firstCatBtn) {
            const catId = firstCatBtn.getAttribute('data-cat-id');
            filterServices(catId, firstCatBtn);
        }
        document.querySelectorAll('.icon-colored').forEach(img => img.style.filter = 'none');
    });

    window.filterServices = function(catId, btnElement) {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        const grid = document.getElementById('services-grid');
        grid.style.minHeight = '200px'; 
        grid.innerHTML = '<div class="col-span-full py-20 text-center text-primary-DEFAULT animate-pulse"><i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3"></i><p class="text-xs uppercase tracking-widest opacity-70">Carregando...</p></div>';

        fetch(`/api/get_services/?categoria_id=${catId}`)
            .then(res => res.json())
            .then(data => {
                if(data.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-gray-400 py-10 italic">Nenhum serviço nesta categoria.</div>';
                    return;
                }
                grid.innerHTML = data.map(s => `
                    <div onclick="selectServiceInternal(${s.id}, '${s.nome.replace(/'/g, "\\'")}', '${s.preco}', '${s.tempo}')" 
                         class="group bg-white border border-pink-100 h-24 px-5 rounded-2xl cursor-pointer hover:border-primary-DEFAULT hover:bg-pink-50 transition-all duration-300 relative overflow-hidden flex justify-between items-center shadow-sm hover:shadow-md">
                        <div class="relative z-10 flex-1 pr-4">
                            <h4 class="text-gray-700 font-bold text-lg mb-1 font-serif tracking-wide truncate group-hover:text-primary-strong transition-colors">${s.nome}</h4>
                            <div class="flex items-center gap-4 text-xs font-medium uppercase tracking-wider">
                                <span class="text-gray-400"><i class="fa-regular fa-clock text-primary-DEFAULT mr-1"></i> ${s.tempo} min</span>
                                <span class="text-primary-strong font-bold">R$ ${formatMoney(s.preco)}</span>
                            </div>
                        </div>
                        <div class="w-10 h-10 rounded-full bg-pink-50 border border-pink-100 flex items-center justify-center text-primary-DEFAULT group-hover:bg-primary-DEFAULT group-hover:text-white transition-all transform group-hover:rotate-45 shrink-0">
                            <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>
                `).join('');
            });
    };

    window.selectServiceInternal = function(id, nome, preco, tempo) {
        bookingState.servicoId = id;
        bookingState.resumo.servico = nome;
        bookingState.resumo.preco = preco;

        showLoader(true);
        fetch(`/api/get_professionals/?servico_id=${id}`)
            .then(res => res.json())
            .then(data => {
                showLoader(false);
                const grid = document.getElementById('professionals-grid');
                if (!data || data.length === 0) {
                      Swal.fire('Ops!', 'Não encontramos profissionais.', 'warning');
                      return;
                }
                grid.innerHTML = data.map(p => `
                    <div onclick="selectProfessionalInternal(${p.id}, this.getAttribute('data-name'))" data-name="${p.nome}"
                         class="group bg-white border border-pink-100 rounded-[2.5rem] cursor-pointer hover:border-primary-DEFAULT hover:shadow-lg hover:shadow-pink-100 transition-all overflow-hidden flex flex-col relative h-full shadow-sm">
                        <div class="relative w-full aspect-square bg-pink-50 overflow-hidden border-b border-pink-100">
                            <img src="${p.foto_url || `https://ui-avatars.com/api/?name=${p.nome}&background=fce7f3&color=db2777&bold=true`}" 
                                 class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-700">
                        </div>
                        <div class="p-5 text-center flex flex-col justify-center flex-grow bg-white group-hover:bg-pink-50 transition-colors">
                            <h4 class="text-gray-700 font-bold text-xl font-serif leading-tight truncate w-full group-hover:text-primary-strong transition-colors">${p.nome}</h4>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-2 block">${p.especialidade || 'Especialista'}</span>
                        </div>
                    </div>
                `).join('');
                goToStep(2);
            })
            .catch(error => { showLoader(false); });
    };

    window.selectProfessionalInternal = function(id, nome) {
        selectProfessional(id, nome); 
        goToStep(3); 
    };

    window.fetchTimeSlots = function(dateStr) {
        bookingState.data = dateStr;
        const container = document.getElementById('time-slots');
        const displayDate = document.getElementById('selected-date-display');
        if(displayDate) displayDate.innerText = formatDateBR(dateStr);

        container.innerHTML = '<div class="col-span-2 py-10 text-center text-primary-DEFAULT animate-pulse text-xs uppercase tracking-widest">Buscando disponibilidade...</div>';

        fetch(`/api/get_slots/?data=${dateStr}&profissional=${bookingState.profissionalId}&servico=${bookingState.servicoId}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = '';
                if(data.message || !data.slots || data.slots.length === 0) {
                      container.innerHTML = `<div class="col-span-2 py-12 text-center text-gray-400 border border-dashed border-pink-200 rounded-xl text-sm">Agenda cheia.</div>`;
                      return;
                }

                data.slots.forEach(slot => {
                    const btn = document.createElement('button');
                    // CORREÇÃO 1: HOVER AGORA DEIXA FUNDO CLARO (Pink-100) E TEXTO ESCURO (Pink-800)
                    // Fundo inativo: Branco. Fundo ativo: Pink-100.
                    btn.className = `py-3 rounded-xl font-bold text-sm transition-all border ${
                        slot.disponivel 
                        ? "bg-white border-pink-200 text-gray-600 hover:border-primary-DEFAULT hover:bg-pink-100 hover:text-pink-800 shadow-sm" 
                        : "bg-pink-50 border-transparent text-gray-300 line-through cursor-not-allowed"
                    }`;
                    btn.innerText = slot.hora;
                    if(slot.disponivel) {
                        btn.onclick = () => { selectTime(slot.hora); goToStep(4); };
                    } else {
                        btn.disabled = true;
                    }
                    container.appendChild(btn);
                });
            });
    };

    function goToStep(stepNum) {
        const currentActive = document.querySelector('.step-content.active') || document.querySelector('.step-enter-right') || document.querySelector('.step-enter-left');
        let currentId = 1;
        if(currentActive && currentActive.id) { const parts = currentActive.id.split('-'); if (parts.length > 1) currentId = parseInt(parts[1]); }
        const direction = stepNum > currentId ? 'forward' : 'backward';
        document.querySelectorAll('.step-content').forEach(el => { el.style.display = 'none'; el.classList.remove('active', 'step-enter-right', 'step-enter-left'); });
        const nextStep = document.getElementById(`step-${stepNum}`);
        if(nextStep) {
            nextStep.style.removeProperty('display'); 
            if(direction === 'forward') nextStep.classList.add('step-enter-right'); else nextStep.classList.add('step-enter-left');
            setTimeout(() => nextStep.classList.add('active'), 10);
        }
        updateStepperUI(stepNum);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        if(stepNum === 3 && typeof calendarInstance !== 'undefined') setTimeout(() => calendarInstance.redraw(), 50);
    }

    function updateStepperUI(stepNum) {
        for(let i=1; i<=4; i++) {
            const indicator = document.getElementById(`step-indicator-${i}`);
            const circle = indicator.querySelector('div');
            const text = indicator.querySelector('span');
            indicator.classList.remove('opacity-50', 'scale-110');
            if(i <= stepNum) {
                indicator.classList.add('scale-110');
                circle.className = "w-10 h-10 rounded-full bg-primary-DEFAULT text-white flex items-center justify-center font-bold mb-2 shadow-md shadow-pink-200 transition-all duration-500";
                text.className = "text-[10px] uppercase tracking-widest text-primary-strong font-bold transition-colors duration-500";
            } else {
                indicator.classList.add('opacity-50');
                circle.className = "w-10 h-10 rounded-full bg-white border border-pink-100 text-gray-400 flex items-center justify-center font-bold mb-2 transition-all duration-500";
                text.className = "text-[10px] uppercase tracking-widest text-gray-400 font-bold transition-colors duration-500";
            }
        }
    }
</script>
{% endblock %}