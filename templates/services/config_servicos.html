{% extends 'base.html' %}

{% block title %}Meus Serviços{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Catálogo de Serviços</h1>
            <p class="text-gray-500 text-sm">Organize seus preços, tempos de atendimento e ícones.</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'dashboard' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                <i class="fa-solid fa-arrow-left"></i> Voltar
            </a>
            <button onclick="novaCategoria()" class="bg-accent text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow">
                <i class="fa-solid fa-folder-plus mr-2"></i> Nova Categoria
            </button>
        </div>
    </div>

    <div id="lista-categorias" class="space-y-6">
        {% for categoria in categorias %}
        <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100" id="cat-card-{{ categoria.id }}">
            
            <div class="bg-gray-50 px-6 py-4 flex justify-between items-center border-b border-gray-100">
                <div class="flex items-center gap-3">
                    {% if categoria.icone %}
                        <img src="{{ categoria.icone.url }}" class="w-10 h-10 rounded-lg object-cover shadow-sm border border-gray-200">
                    {% else %}
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-accent">
                            <i class="fa-solid fa-folder text-xl"></i>
                        </div>
                    {% endif %}
                    <h3 class="text-lg font-bold text-gray-700">{{ categoria.nome }}</h3>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="novoServico('{{ categoria.id }}')" class="text-sm bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded hover:bg-gray-50 transition font-medium">
                        <i class="fa-solid fa-plus text-accent mr-1"></i> Serviço
                    </button>
                    <button onclick="excluirCategoria('{{ categoria.id }}')" class="text-red-400 hover:text-red-600 px-2 transition bg-white border border-transparent hover:border-red-100 rounded py-1" title="Excluir Categoria">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="p-0">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-xs text-gray-400 bg-white uppercase border-b border-gray-100">
                            <th class="px-6 py-2 font-semibold">Serviço</th>
                            <th class="px-6 py-2 font-semibold">Preço</th>
                            <th class="px-6 py-2 font-semibold">Tempo</th>
                            <th class="px-6 py-2 font-semibold text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="tbody-cat-{{ categoria.id }}">
                        {% for servico in categoria.servicos.all %}
                        <tr class="hover:bg-blue-50 transition group" id="servico-row-{{ servico.id }}">
                            <td class="px-6 py-4 flex items-center gap-3">
                                {% if servico.icone %}
                                    <img src="{{ servico.icone.url }}" class="w-8 h-8 rounded-full object-cover border border-gray-200">
                                {% else %}
                                    <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 text-xs">
                                        <i class="fa-solid fa-scissors"></i>
                                    </div>
                                {% endif %}
                                <span class="font-medium text-gray-800">{{ servico.nome }}</span>
                            </td>
                            <td class="px-6 py-4 text-green-600 font-bold text-sm">R$ {{ servico.preco }}</td>
                            <td class="px-6 py-4 text-gray-500 text-sm"><i class="fa-regular fa-clock mr-1"></i> {{ servico.tempo_execucao }} min</td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="editarServico('{{ servico.id }}', '{{ servico.nome }}', '{{ servico.preco }}', '{{ servico.tempo_execucao }}')" 
                                        class="text-blue-400 hover:text-blue-600 mr-3 p-1 rounded hover:bg-blue-100 transition">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="excluirServico('{{ servico.id }}')" class="text-red-300 hover:text-red-500 p-1 rounded hover:bg-red-100 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="empty-cat-{{ categoria.id }}">
                            <td colspan="4" class="px-6 py-8 text-center text-gray-400 italic text-sm">
                                Nenhum serviço cadastrado nesta categoria.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-12">
            <div class="inline-block p-4 rounded-full bg-blue-50 text-accent mb-4">
                <i class="fa-solid fa-folder-open text-4xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">Comece por aqui!</h3>
            <p class="text-gray-500">Crie sua primeira categoria (ex: Cabelo, Barba) para adicionar serviços.</p>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Função auxiliar para pegar o token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- 1. Nova Categoria (com Upload) ---
    function novaCategoria() {
        Swal.fire({
            title: 'Nova Categoria',
            html: `
                <div class="text-left">
                    <label class="text-xs font-bold text-gray-400 uppercase">Nome da Categoria</label>
                    <input id="cat-nome" class="swal2-input !m-0 !w-full !mb-4" placeholder="Ex: Cabelo, Barba...">
                    
                    <label class="text-xs font-bold text-gray-400 uppercase">Ícone (Opcional)</label>
                    <input type="file" id="cat-icone" class="block w-full text-sm text-slate-500 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            confirmButtonColor: '#3b82f6',
            preConfirm: () => {
                const nome = document.getElementById('cat-nome').value;
                const file = document.getElementById('cat-icone').files[0];
                
                if (!nome) return Swal.showValidationMessage('O nome é obrigatório');
                
                // Usamos FormData para enviar arquivos
                const fd = new FormData();
                fd.append('nome', nome);
                if(file) fd.append('icone', file);
                return fd;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{% url 'api_add_categoria' %}", {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')},
                    body: result.value // Envia o FormData
                }).then(res => res.json()).then(data => {
                    if(data.status === 'success') location.reload();
                    else Swal.fire('Erro', data.message, 'error');
                });
            }
        });
    }

    // --- 2. Excluir Categoria ---
    function excluirCategoria(id) {
        Swal.fire({
            title: 'Tem certeza?',
            text: "Todos os serviços desta categoria também serão apagados!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Sim, excluir',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/servicos/api/delete_categoria/${id}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                }).then(res => res.json()).then(data => {
                    if(data.status === 'success') {
                        document.getElementById(`cat-card-${id}`).remove();
                        Swal.fire({title: 'Excluído!', icon: 'success', timer: 1500, showConfirmButton: false});
                    }
                });
            }
        })
    }

    // --- 3. Novo Serviço (com Upload) ---
    function novoServico(catId) {
        Swal.fire({
            title: 'Novo Serviço',
            html: `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase">Nome</label>
                        <input id="s-nome" class="swal2-input !m-0 !w-full" placeholder="Ex: Corte Degrade">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Preço (R$)</label>
                            <input id="s-preco" type="number" step="0.01" class="swal2-input !m-0 !w-full" placeholder="0.00">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Tempo (min)</label>
                            <input id="s-tempo" type="number" class="swal2-input !m-0 !w-full" placeholder="30">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase">Ícone (Opcional)</label>
                        <input type="file" id="s-icone" class="block w-full text-sm text-slate-500 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            confirmButtonColor: '#3b82f6',
            preConfirm: () => {
                const fd = new FormData();
                fd.append('categoria_id', catId);
                fd.append('nome', document.getElementById('s-nome').value);
                fd.append('preco', document.getElementById('s-preco').value);
                fd.append('tempo', document.getElementById('s-tempo').value);
                const file = document.getElementById('s-icone').files[0];
                if(file) fd.append('icone', file);
                
                if(!fd.get('nome') || !fd.get('preco') || !fd.get('tempo')) {
                    return Swal.showValidationMessage('Preencha os campos obrigatórios');
                }
                return fd;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{% url 'api_add_service' %}", {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')},
                    body: result.value
                }).then(res => res.json()).then(resp => {
                    if(resp.status === 'success') location.reload();
                    else Swal.fire('Erro', resp.message, 'error');
                });
            }
        });
    }

    // --- 4. Excluir Serviço ---
    function excluirServico(id) {
        Swal.fire({
            title: 'Apagar serviço?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Sim',
            cancelButtonText: 'Não'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/servicos/api/delete_service/${id}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')}
                }).then(res => res.json()).then(data => {
                    if(data.status === 'success') {
                        document.getElementById(`servico-row-${id}`).remove();
                        Swal.fire({title: 'Apagado!', icon: 'success', timer: 1500, showConfirmButton: false});
                    }
                });
            }
        })
    }

    // --- 5. Editar Serviço (com Upload) ---
    function editarServico(id, nome, preco, tempo) {
        Swal.fire({
            title: 'Editar Serviço',
            html: `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase">Nome</label>
                        <input id="e-nome" class="swal2-input !m-0 !w-full" value="${nome}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Preço (R$)</label>
                            <input id="e-preco" type="number" step="0.01" class="swal2-input !m-0 !w-full" value="${preco}">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Tempo (min)</label>
                            <input id="e-tempo" type="number" class="swal2-input !m-0 !w-full" value="${tempo}">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase">Alterar Ícone</label>
                        <input type="file" id="e-icone" class="block w-full text-sm text-slate-500 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Atualizar',
            confirmButtonColor: '#3b82f6',
            preConfirm: () => {
                const fd = new FormData();
                fd.append('nome', document.getElementById('e-nome').value);
                fd.append('preco', document.getElementById('e-preco').value);
                fd.append('tempo', document.getElementById('e-tempo').value);
                const file = document.getElementById('e-icone').files[0];
                if(file) fd.append('icone', file);
                return fd;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/servicos/api/edit_service/${id}/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCookie('csrftoken')},
                    body: result.value
                }).then(res => res.json()).then(resp => {
                    if(resp.status === 'success') location.reload();
                    else Swal.fire('Erro', 'Não foi possível atualizar.', 'error');
                });
            }
        });
    }
</script>
{% endblock %}